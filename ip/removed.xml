
Finally, <xref target="mapping-tsn"/>
        provides rules for mapping IP-based DetNet flows to IEEE 802.1
        TSN streams.
		
		The mapping of DetNet IP flows to TSN
        streams and TSN protection mechanisms is covered in <xref
        target="mapping-tsn"/>.
		

<!--    <section title="DetNet IP Data Plane Overview" anchor="sec_dt_dp">
 -->

      <figure align="center" anchor="fig_ip_detnet"
              title="DetNet IP Over DetNet MPLS Network">
        <artwork><![CDATA[
 DetNet IP       Relay         Transit         Relay       DetNet IP
 End System      Node           Node           Node        End System

+----------+                                              +----------+
|   Appl.  |<-------------- End to End Service ---------->|   Appl.  |
+----------+   .....-----+                  +-----.....   +----------+
| Service  |<--: Service |-- DetNet flow ---| Service :-->| Service  |
|          |   :         |<- DN MPLS flow ->|         :   |          |
+----------+   +---------+   +----------+   +---------+   +----------+
|Forwarding|   |Fwd| |Fwd|   |Forwarding|   |Fwd| |Fwd|   |Forwarding|
+--------.-+   +-.-+ +-.-+   +---.----.-+   +-.-+ +-.-+   +----.-----+
         :  Link :    /  ,-----.  \   :  Link :    /  ,-----.  \
         +.......+    +-[  Sub  ]-+   +.......+   +--[  Sub  ]--+
                        [Network]                    [Network]
                         `-----'                      `-----'

                       |<---- DetNet MPLS --->|
         |<--------------------- DetNet IP ------------------->|
                         ]]></artwork>
      </figure>
      <t>
        <xref target="fig_ip_detnet"/> illustrates a variant of <xref
        target="fig_ip_detnet_simple"/>, with an MPLS based DetNet
        network as a sub-network between the relay nodes.  It shows a
        more complex DetNet enabled IP network where an IP flow is
        mapped to one or more PWs and MPLS (TE) LSPs.  The end systems
        still originate IP encapsulated traffic that is identified as
        DetNet flows.  The relay nodes follow procedures defined in
        <xref target="ip-over-mpls"/> to map each DetNet
        flow to MPLS LSPs. While not shown, relay nodes can provide
        service sub-layer functions such as PREOF using DetNet over MPLS,
        and this is indicated by the solid line for the MPLS
        facing portion of the Service component. Note that the Transit
        node is MPLS (TE) LSP aware and performs switching based on MPLS
        labels, and need not have any specific knowledge of the DetNet
        service or the corresponding DetNet flow identification. See
        <xref target="ip-over-mpls"/> for details on the mapping of IP
        flows to MPLS, and <xref target="I-D.ietf-detnet-dp-sol-mpls"/>
        for general support of DetNet services using MPLS.
      </t>
	  
<!--    <section title="DetNet IP Data Plane Considerations" anchor="dn-gen-encap-solution">
 -->	  
    	  At a high level, the
        following are provided on a per flow basis:
        <list style="hanging">
          <t hangText="Congestion protection and latency control:">
            <vspace blankLines="1"/>
            Usage of allocated resources (queuing, policing, shaping) to ensure
            that the congestion-related loss and latency/jitter requirements of
            a DetNet flow are met.
          </t>
          <t hangText="Explicit routes:">
            <vspace blankLines="1"/>
            Use of a specific path for a flow.  This limits
            misordering and can improve delivery of deterministic latency.
          </t>

          <t hangText="Service protection:">
            <vspace blankLines="1"/>
            Which in the case of this document
            translates to changing the explicit path after a failure is
            detected in order to restore delivery of the required DetNet service
            characteristics. Path changes, even in the case of failure
            recovery, can lead to the out of order delivery of data.
          </t>
          <t>
            Note: DetNet PREOF is not provided by the mechanisms defined in
            this document.
          </t>
          <t hangText="Load sharing:">
            <vspace blankLines="1"/>
            Generally, distributing packets of the same DetNet flow over
            multiple paths is not recommended. Such load sharing,
            e.g., via ECMP or UCMP, impacts ordering and end-to-end jitter.
          </t>
          <t hangText="Troubleshooting:"> <vspace blankLines="1"/>
          For example, to support identification of misbehaving flows.
          </t>
          <t hangText="Recognize flow(s) for analytics:"><vspace blankLines="1"/>
          For example, increase counters.
          </t>
          <t hangText="Correlate events with flows:"><vspace blankLines="1"/>
          For example, unexpected loss.
          </t>
        </list>
		
		
		
        <section title="Networks With Multiple Technology Segments" anchor="nwsegments">
          <!-- alternate title:
               "Mapping DetNet IP Flows to Sub-Networks and Links">
          -->
          <t>
            There are network scenarios, where the DetNet domain contains
            multiple technology segments (IEEE 802.1 TSN, MPLS) and all those
            segments are under the same administrative control (see <xref
            target="fig_pref_xcrs_segments"/>). Furthermore, DetNet nodes may be
            interconnected via TSN segments.
          </t>
          <t>
            DetNet routers ensure that detnet service requirements are
            met per hop by allocating local resources, both receive and
            transmit, and by mapping the service requirements of each
            flow to appropriate sub-network mechanisms.  Such mapping is
            sub-network technology specific.  The mapping of DetNet IP
            Flows to MPLS is covered <xref
            target="ip-over-mpls"/>.  The mapping of IP
            DetNet Flows to IEEE 802.1 TSN is covered in <xref
            target="mapping-tsn"/>.
          </t>

          <figure title="DetNet domains and multiple technology segments" anchor="fig_pref_xcrs_segments">
            <artwork align="center"><![CDATA[
                                   ______
                         _____    /      \__
            ____        /     \__/          \___    ______
+----+   __/    +======+                        +==+      \   +----+
|src |__/  Seg1  )     |                        |  \  Seg3 \__| dst|
+----+  \_______+      \        Segment-2       |   \+_____/  +----+
                 \======+__                    _+===/
                           \         __     __/
                            \_______/  \___/
                            ]]>
          </artwork></figure>

        </section>



<!--      <section title="Class of Service">
 -->
        <t>
          Class and quality of service, i.e., CoS and QoS, are terms that are
          often used interchangeably and confused.  In the context of DetNet,
          CoS is used to refer to mechanisms that provide traffic forwarding
          treatment based on aggregate group basis and QoS is used to refer
          to mechanisms that provide traffic forwarding treatment based on a
          specific DetNet flow basis.  Examples of existing network level CoS
          mechanisms include DiffServ which is enabled by IP header
          differentiated services code point (DSCP) field <xref
          target="RFC2474"/> and MPLS label traffic class field <xref
          target="RFC5462"/>, and at Layer-2, by IEEE 802.1Q Priority Code
          Point (PCP).
        </t>

<!--      <section title="Quality of Service" anchor="QoS">
 -->		
        <t>
          Quality of Service (QoS) mechanisms for flow-specific traffic
          treatment typically includes a guarantee/agreement for the service,
          and allocation of resources to support the service.  Example QoS
          mechanisms include discrete resource allocation, admission control,
          flow identification and isolation, and sometimes path control, traffic
          protection, shaping, policing and remarking. Example protocols that
          support QoS control include <xref target="RFC2205">Resource
          ReSerVation Protocol (RSVP)</xref> (RSVP) and RSVP-TE <xref
          target="RFC3209"/> and <xref target="RFC3473"/>.  The existing MPLS
          mechanisms defined to support CoS <xref target="RFC3270"/> can also be
          used to reserve resources for specific traffic classes.
        </t>
        <t>
          In addition to explicit routes, and packet replication and
          elimination, DetNet provides zero congestion loss and bounded latency
          and jitter.  As described in <xref
          target="I-D.ietf-detnet-architecture"/>, there are different
          mechanisms that maybe used separately or in combination to deliver a
          zero congestion loss service.  These mechanisms are provided by the
          either the MPLS or IP layers, and may be combined with the mechanisms
          defined by the underlying network layer such as 802.1TSN.
        </t>
        <t>
          A baseline set of QoS capabilities for DetNet flows carried in PWs
          and MPLS can provided by MPLS with Traffic Engineering (MPLS-TE)
          <xref target="RFC3209"/> and <xref target="RFC3473"/>.  TE LSPs can
          also support explicit routes (path pinning).  Current service
          definitions for packet TE LSPs can be found in "Specification of
          the Controlled Load Quality of Service", <xref target="RFC2211"/>,
          "Specification of Guaranteed Quality of Service", <xref
          target="RFC2212"/>, and "Ethernet Traffic Parameters", <xref
          target="RFC6003"/>. Additional service definitions are expected in
          future documents to support the full range of DetNet services.
          In all cases, the existing label-based marking mechanisms defined
          for TE-LSPs and even E-LSPs are use to support the identification
          of flows requiring DetNet QoS.
        </t>

    <!-- ===================================================================== -->
    <section title="Time Synchronization">
     <t>
      While time synchronization can be important both from the perspective of
      operating the DetNet network itself and from the perspective of
      DetNet-based applications, time synchronization is outside the
      scope of this document.  This said, a DetNet node can also support
      time synchronization or distribution mechanisms.
     </t>
     <t>
      For example, <xref target="RFC8169"/> describes a method
      of recording the packet queuing time in an MPLS LSR on a packet by
      per packet basis and forwarding this information to the egress edge
      system.  This allows compensation for any variable packet queuing
      delay to be applied at the packet receiver. Other mechanisms for
      IP networks are
      defined based on IEEE Standard 1588 <xref target="IEEE1588"/>,
      such as ITU-T <xref target="G.8275.1"/> and <xref target="G.8275.2"/>.
     </t>
     <t>
      A more detailed discussion of time synchronization is outside the
      scope of this document.
     </t>
    </section>
	
	
    <section title="Management and Control Considerations" anchor="m-cp-considerations">
      <t>
        While management plane and control planes are traditionally
        considered separately, from the Data Plane perspective there is
        no practical difference based on the origin of flow provisioning
        information, and the DetNet architecture <xref
        target="I-D.ietf-detnet-architecture"/> refers to these
        collectively as the 'Controller Plane'.  This document therefore
        does not distinguish between information provided by distributed
        control plane protocols, e.g., IGP routing protocols, or by
        centralized network management mechanisms, e.g., RestConf <xref
        target="RFC8040"/>, YANG <xref target="RFC7950"/>, and the Path
        Computation Element Communication Protocol (PCEP) <xref
        target="RFC8283"/> <xref target="I-D.ietf-teas-pce-native-ip"/>
        or any combination thereof. Specific considerations and
        requirements for the DetNet Controller Plane are discussed in
        <xref target="control-management-requirements"/>.
      </t>	
      </section>

      <section title="Explcit Routes">
        <t>
          Explicit routes are used to ensure that packets are routed
          through the resources that have been reserved for them, and
          hence provide the DetNet application with the required
          service. A requirement for the DetNet Controller Plane will be
          the ability to assign a particular identified DetNet IP flow
          to a path through the DetNet domain that has been assigned the
          required nodal resources to provide the appropriate traffic
          treatment for the flow, and also to include particular links
          as a part of the path that are able to support the DetNet
          flow, for example by using IEEE 802.1 TSN links (as discussed
          in <xref target="mapping-tsn"/>). Further considerations and
          requirements for the DetNet Controller Plane are discussed in
          <xref target="control-management-requirements"/>.
        </t>
        <t>
          Whether configuring, calculating and instantiating these
          routes is a single-stage or multi-stage process, or in a
          centralized or distributed manner, is out of scope of this
          document.
        </t>
        <t>
          There are several of approaches that could be used to provide
          explicit routes and resource allocation in the DetNet
          layer. For example:
          <list style="symbols">
            <t>
              The path could be explicitly set up by a controller which
              calculates the path and explicitly configures each node
              along that path with the appropriate forwarding and
              resource allocation information.
            </t>
            <t>
              The path could be used a distributed control plane such as
              <xref target="RFC2205">RSVP</xref> or RSVP-TE <xref
              target="RFC3473"/> extended to support DetNet IP flows.
            </t>
            <t>
              The path could be implemented using IPv6-based segment
              routing when extended to support resource allocation.
            </t>
          </list>
          See <xref target="control-management-requirements"/> for
          further discussion of these alternatives. In addition, <xref
          target="RFC2386"/> contains useful background information on
          QoS-based routing, and <xref target="RFC5575"/> discusses a
          specific mechanism used by BGP for traffic flow specification
          and policy-based routing.
        </t>
      </section>

      <section title="Contention Loss and Jitter Reduction">
        <t>
          As discussed in <xref target="sec_intro"/>, this document does
          not specify the mechanisms needed to eliminate contention loss
          or reduce jitter for DetNet flows at the DetNet forwarding
          sub-layer.  The ability to manage node and link resources to
          be able to provide these functions will be a necessary part of
          the DetNet controller plane. It will also be necessary to be
          able to control the required queuing mechanisms used to
          provide these functions along a flow's path through the
          network. See <xref target="ip-svc"/> and <xref
          target="control-management-requirements"/> for further
          discussion of these requirements.
        </t>
      </section>

<!--      <section title="Bidirectional Traffic">	  
-->

        <t>
          Some DetNet applications generate bidirectional traffic.
          Although this document discusses the DetNet IP data plane,
          MPLS definitions <xref target="RFC5654"/> are useful to
          illustrate terms such as associated bidirectional flows and
          co-routed bidirectional flows.  MPLS defines a point-to-point
          associated bidirectional LSP as consisting of two
          unidirectional point-to-point LSPs, one from A to B and the
          other from B to A, which are regarded as providing a single
          logical bidirectional forwarding path.  This is analogous to
          standard IP routing.  MPLS defines a point-to-point co-routed
          bidirectional LSP as an associated bidirectional LSP which
          satisfies the additional constraint that its two
          unidirectional component LSPs follow the same path (in terms
          of both nodes and links) in both directions.  An important
          property of co-routed bidirectional LSPs is that their
          unidirectional component LSPs share fate.  In both types of
          bidirectional LSPs, resource reservations may differ in each
          direction.  The concepts of associated bidirectional flows and
          co-routed bidirectional flows can also be applied to DetNet IP
          flows.
        </t>

        <t>
          This is further discussed in <xref
          target="control-management-requirements"/>.
        </t>
      </section>
      <section anchor="control-management-requirements"
               title="DetNet Controller (Control and Management) Plane Requirements">
        <t>
          While the definition of controller plane for DetNet is out of
          the scope of this document, there are particular
          considerations and requirements for such that result from the
          unique characteristics of the DetNet architecture <xref
          target="I-D.ietf-detnet-architecture"/> and data plane as
          defined herein.
        </t>
        <t>
          The primary requirements of the DetNet controller plane are
          that it must be able to:
          <list style="symbols">
            <t>
              Instantiate DetNet flows in a DetNet domain (which may
              include some or all of explicit path determination, link
              bandwidth reservations, restricting flows to IEEE 802.1 TSN
              links, node buffer and other resource reservations,
              specification of required queuing disciplines along the
              path, ability to manage bidirectional flows, etc.) as needed
              for a flow.
            </t>
            <t>
              The ability to support DetNet flow aggregation
            </t>
            <t>
              Advertise static and dynamic node and link resources such
              as capabilities and adjacencies to other network nodes (for
              dynamic signaling approaches) or to network controllers (for
              centralized approaches)
            </t>
            <t>
              Scale to handle the number of DetNet flows expected in a
              domain (which may require per-flow signaling or
              provisioning)
            </t>
            <t>
              Provision flow identification information at each of the
              nodes along the path, and it may differ depending on the
              location in the network and the DetNet functionality.
            </t>
          </list>
        </t>
        <t>
          These requirements, as stated earlier, could be satisfied
          using distributed control protocol signaling, centralized
          network management provisioning mechanisms, or hybrid
          combinations of the two, and could also make use of IPv6-based
          segment routing.
        </t>
        <t>
          In the abstract, the results of either distributed signaling
          or centralized provisioning are equivalent from a DetNet data
          plane perspective - flows are instantiated, explicit routes
          are determined, resources are reserved, and packets are
          forwarded through the domain using the IP data plane.
        </t>
        <t>
          However, from a practical and implementation standpoint, they
          are not equivalent at all. Some approaches are more scalable
          than others in terms of signaling load on the network. Some
          can take advantage of global tracking of resources in the
          DetNet domain for better overall network resource
          optimization. Some are more resilient than others if link,
          node, or management equipment failures occur. While a detailed
          analysis of the control plane alternatives is out of the scope
          of this document, the requirements from this document can be
          used as the basis of a later analysis of the alternatives.
        </t>
    </section>

    <!-- ===================================================================== -->

    <section anchor="ip-over-mpls" title="IP over DetNet MPLS">
      <t>
        This section defines how IP encapsulated flows are carried over
        a DetNet MPLS data plane as defined in <xref
        target="I-D.ietf-detnet-dp-sol-mpls"/>.  As Non-DetNet and
        DetNet IP packets are identical on the wire, this section is
        applicable to any node that supports IP over DetNet MPLS, and
        this section refers to both cases as DetNet IP over DetNet MPLS.
      </t>

      <section title="IP Over DetNet MPLS Data Plane Scenarios"
               anchor="sec_ip_mpls_dt_dp_scen">
        <t>
          This section provides example uses of IP over DetNet MPLS for
          illustrative purposes.
        </t>
        <figure align="center" anchor="fig_dn_ip_mpls_detnet"
                title="DetNet IP Over MPLS Network">
          <artwork><![CDATA[
IP  DetNet        Relay       Transit         Relay       IP DetNet
End System        Node         Node           Node        End System
                  (T-PE)       (LSR)          (T-PE)
+----------+                                             +----------+
|   Appl.  |<------------ End to End Service ----------->|   Appl.  |
+----------+   .....-----+                 +-----.....   +----------+
| Service  |<--: Service |-- DetNet flow --| Service :-->| Service  |
+----------+   +---------+  +----------+   +---------+   +----------+
|Forwarding|   |Fwd| |Fwd|  |Forwarding|   |Fwd| |Fwd|   |Forwarding|
+-------.--+   +-.-+ +-.-+  +----.---.-+   +-.-+ +-.-+   +---.------+
        :  Link  :    /  ,-----.  \   : Link :    /  ,-----.  \
        +........+    +-[  Sub  ]-+   +......+    +-[  Sub  ]-+
                        [Network]                   [Network]
                         `-----'                     `-----'

        |<- DN IP->| |<---- DetNet MPLS ---->| |< -DN IP ->|
        ]]></artwork>
        </figure>
        <t>
          <xref target="fig_dn_ip_mpls_detnet"/> illustrates DetNet
          enabled End Systems (hosts), connected to DetNet (DN) enabled
          IP networks, operating over a DetNet aware MPLS network. In
          this figure, Relay nodes sit at the boundary of the MPLS
          domain since the non-MPLS domain is DetNet aware.  This figure
          is very similar to the DetNet MPLS Network figure in <xref
          target="I-D.ietf-detnet-dp-sol-mpls"/>.  The primary
          difference is that the Relay nodes are at the edges of the
          MPLS domain and therefore function as T-PEs, and that service
          sub-layer functions are not provided over the DetNet IP
          network.  The transit node functions show above are identical
          to those described in <xref
          target="I-D.ietf-detnet-dp-sol-mpls"/>.
        </t>

        <t>
          <xref target="fig_ip_pw_detnet"/> illustrates how relay nodes
          can provide service protection over an MPLS domain.  In this
          case, CE1 and CE2 are IP DetNet end systems which are
          interconnected via a MPLS domain such as described in <xref
          target="I-D.ietf-detnet-dp-sol-mpls"/>. Note that R1 and R3
          sit at the edges of an MPLS domain and therefore are similar
          to T-PEs, while R2 sits in the middle of the domain and is
          therefore similar to an S-PE.
        </t>

        <figure align="center" anchor="fig_ip_pw_detnet"
                title="DetNet IP Over DetNet MPLS Network">
          <artwork><![CDATA[
      DetNet                                         DetNet
IP    Service         Transit          Transit       Service  IP
DetNet               |<-Tnl->|        |<-Tnl->|               DetNet
End     |            V   1   V        V   2   V            |  End
System  |   +--------+       +--------+       +--------+   |  System
+---+   |   |   R1   |=======|   R2   |=======|   R3   |   |   +---+
|   |-------|._X_....|..DF1..|.__ ___.|..DF3..|...._X_.|-------|   |
|CE1|   |   |    \   |       |   X    |       |   /    |   |   |CE2|
|   |   |   |     \_.|..DF2..|._/ \__.|..DF4..|._/     |   |   |   |
+---+       |        |=======|        |=======|        |       +---+
    ^       +--------+       +--------+       +--------+       ^
    |        Relay Node       Relay Node       Relay Node      |
    |          (T-PE)           (S-PE)          (T-PE)         |
    |                                                          |
    |<-DN IP-> <-------- DetNet MPLS ---------------> <-DN IP->|
    |                                                          |
    |<-------------- End to End DetNet Service --------------->|

   -------------------------- Data Flow ------------------------->

    X   = Service protection (PRF, PREOF, PEF/POF)
    DFx = DetNet member flow x over a TE LSP
    ]]></artwork>
        </figure>

        <figure align="center" anchor="fig_ip_mpls_detnet"
                title="Non-DetNet Aware IP Over DetNet MPLS Network">
          <artwork><![CDATA[
 IP               Edge                        Edge        IP
 End System       Node                        Node        End System
                 (T-PE)       (LSR)          (T-PE)
+----------+   +....-----+                 +-----....+   +----------+
|   Appl.  |<--:Svc Proxy|-- E2E Service --|Svc Proxy:-->|   Appl.  |
+----------+   +.....+---+                 +---+.....+   +----------+
|    IP    |<--:IP : |Svc|-- IP/DN Flow ---|Svc| :IP :-->|    IP    |
+----------+   +---+ +---+  +----------+   +---+ +---+   +----------+
|Forwarding|   |Fwd| |Fwd|  |Forwarding|   |Fwd| |Fwd|   |Forwarding|
+-------.--+   +-.-+ +-.-+  +----.---.-+   +-.-+ +-.-+   +---.------+
        :  Link  :    /  ,-----.  \   : Link :    /  ,-----.  \
        +........+    +-[  Sub  ]-+   +......+    +-[  Sub  ]-+
                        [Network]                   [Network]
                         `-----'                     `-----'

      |<--- IP --->| |<----- DetNet MPLS ----->| |<--- IP --->|
      ]]></artwork>
        </figure>
        <t>
          <xref target="fig_ip_mpls_detnet"/> illustrates non-DetNet
          enabled End Systems (hosts), connected to DetNet (DN) enabled
          MPLS network. It differs from <xref
          target="fig_dn_ip_mpls_detnet"/> in that the hosts and edge IP
          networks are not DetNet aware.  In this case, edge nodes sit at
          the boundary of the MPLS domain since it is also a DetNet domain
          boundary.  The edge nodes provide DetNet service proxies for the
          end applications by initiating and terminating DetNet service
          for the application's IP flows.  While the node types differ,
          there is essentially no difference in data plane processing
          between relay and edges.  There are likely to be differences
          in controller plane operation, particularly when distributed
          control plane protocols are used.
        </t>

        <t>
          <xref target="fig_pw_detnet2"/> illustrates how it is still
          possible to provided DetNet service protection for
          non-DetNet aware end systems.  This figures is basically the
          same as <xref target="fig_ip_pw_detnet"/>, with the exception
          that CE1 and CE2 are non-DetNet aware end systems and E1 and E3
          are edge nodes that replace the relay nodes R1 and R3.
        </t>

        <figure align="center" anchor="fig_pw_detnet2"
                title="MPLS-Based DetNet (non-MPLS End System)">
          <artwork><![CDATA[
      IP                                              IP
Non   Service          Transit          Transit       Service Non
DetNet                |<-Tnl->|        |<-Tnl->|              DetNet
End     |             V   1   V        V   2   V            | End
System  |    +--------+       +--------+       +--------+   | System
+---+   |    |   E1   |=======|   R2   |=======|   E3   |   |  +---+
|   |--------|._X_....|..DF1..|.__ ___.|..DF3..|...._X_.|------|   |
|CE1|   |    |    \   |       |   X    |       |   /    |   |  |CE2|
|   |   |    |     \_.|..DF2..|._/ \__.|..DF4..|._/     |   |  |   |
+---+        |        |=======|        |=======|        |      +---+
             +--------+       +--------+       +--------+
             ^ Edge Node      Relay Node       Edge Node^
             | (T-PE)           (S-PE)          (T-PE)  |
             |                                          |
     <--IP-->| <-------- IP Over DetNet MPLS ---------> |<--IP-->
             |                                          |
             |<------ End to End DetNet Service ------->|

    X   = Optional service protection (none, PRF, PREOF, PEF/POF)
    DFx = DetNet member flow x over a TE LSP
    ]]></artwork>
        </figure>
      </section>

      <section anchor="iom-overview"
               title="DetNet IP over DetNet MPLS Encapsulation">
      <t>
        The basic encapsulation
        approach is to treat a DetNet IP flow as an app-flow from the
        DetNet MPLS app perspective. The corresponding example DetNet
        Sub-Network format is shown in <xref
        target="fig_dn_ip_mpls_sn_ex"/>.
      </t>
      <figure title="Example DetNet IP over MPLS Sub-Network Formats"
              anchor="fig_dn_ip_mpls_sn_ex">
        <artwork align="center"><![CDATA[

           /->     +------+  +------+  +------+              ^
           |       |  X   |  |  X   |  |  X   | IP App-Flow  :
           |       +------+  +------+  +------+              :
MPLS     <-+       |NProto|  |NProto|  |NProto|              :(1)
 App-Flow  |       +------+  +------+  +------+              :
           |       |  IP  |  |  IP  |  |  IP  |              v
           \-> +---+======+--+======+--+======+-----+
DetNet-MPLS        | d-CW |  | d-CW |  | d-CW |              ^
                   +------+  +------+  +------+              :(2)
                   |Labels|  |Labels|  |Labels|              v
               +---+======+--+======+--+======+-----+
Sub-Network        |  L2  |  | TSN  |  | UDP  |
                   +------+  +------+  +------+
                                       |  IP  |
                                       +------+
                                       |  L2  |
                                       +------+
    (1) DetNet IP Flow
    (2) DetNet MPLS Flow
    ]]>
        </artwork>
      </figure>
      <t>
        In the figure, "IP App-Flow" indicates the payload carried by
        the DetNet IP data plane.  "IP" and "NProto" indicate the fields
        described in <xref target="ip-hdr"/> and <xref
        target="nxt-proto"/>, respectively.  "MPLS App-Flow" indicates
        that an individual DetNet IP flow is the payload from the
        perspective of the DetNet MPLS data plane defined in <xref
        target="I-D.ietf-detnet-dp-sol-mpls"/>.
      </t>
      <t>
        Per <xref target="I-D.ietf-detnet-dp-sol-mpls"/>, the DetNet
        MPLS data plane uses a single S-Label to support a single app
        flow. <xref target="ip-flow-id"/> states that a single DetNet
        flow is identified based on IP, and next level protocol, header
        information.  It also defines that aggregation is supported
        (<xref target="ip-agg"/>) through the use of prefixes,
        wildcards, bimasks, and port ranges.  Collectively, this results
        in the fairly straight forward procedures defined in this
        section.
      </t>
      <t>
        As shown in removed fig_ip_detnet, DetNet relay nodes
        are responsible for the mapping of a DetNet flow, at the service
        sub-layer, from the IP to MPLS DetNet data planes and back
        again. Their related DetNet IP over DetNet MPLS data plane
        operation is comprised of two sets of procedures: the mapping of
        flow identifiers; and ensuring proper traffic treatment.
      </t>
      </section>
      <section anchor="iom-ids"
               title="DetNet IP over DetNet MPLS Flow Identification
                      Procedures">
        <t>
          A relay node that sends a DetNet IP flows over a DetNet MPLS
          network MUST map a single DetNet IP flow into a single
          app-flow and MUST process that app-flow in accordance to the
          procedures defined in <xref
          target="I-D.ietf-detnet-dp-sol-mpls"/> Section 6.2.  PRF MAY
          be supported for DetNet IP flows sent over an DetNet MPLS
          network.  Aggregation as defined in <xref target="ip-agg"/>
          MAY be used to identify an individual DetNet IP flow. The
          provisioning of the mapping of DetNet IP flows to DetNet MPLS
          app-flow information MUST be supported via configuration,
          e.g., via the controller plane.
        </t>
        <t>
          A relay node MAY be provisioned to handle packets received via
          the DetNet MPLS data plane as DetNet IP flows.  A single
          incoming MPLS app-flow MAY be treated as a single DetNet IP
          flow, without examination of IP headers. Alternatively,
          packets received via the DetNet MPLS data plane MAY follow the
          normal DetNet IP flow identification procedures defined in
          <xref target="ip-flow-id"/>.  An implementation MUST support
          the provisioning of handling of received DetNet MPLS data
          plane as DetNet IP flows via configuration. Note that
          such configuration MAY include support from PEOF on the
          incoming DetNet MPLS flow.
        </t>
      </section>
      <section anchor="iom-svc"
               title="DetNet IP over DetNet MPLS Traffic Treatment Procedures">
        <t>
          The traffic treatment required for a particular DetNet IP flow
          is provisioned via configuration or the controller plane. When
          an DetNet IP flow is sent over DetNet MPLS a relay node MUST
          ensure that the provisioned DetNet IP traffic treatment is
          provided at the forwarding sub-layer as described in <xref
          target="I-D.ietf-detnet-dp-sol-mpls"/> Section 6.2. Note that
          the PRF function can also be used when sending over MPLS.
        </t>
        <t>
          Traffic treatment for DetNet IP flows received over the DetNet
          MPLS data plane MUST follow <xref target="ip-svc"/>.
        </t>
      </section>
    </section>

    <!--
         =====================================================================
         -->

    <section anchor="mapping-tsn" title="Mapping DetNet IP Flows to IEEE 802.1 TSN">
      <t>
        [Authors note: how do we handle control protocols such as
         ICMP, IPsec, etc.]
      </t>
      <t>
        This section covers how DetNet IP flows operate over an IEEE 802.1 TSN
        sub-network.  <xref target="fig_ip_detnet_to_tsn"/> illustrates such a
        scenario, where two IP (DetNet) nodes are interconnected by a TSN
        sub-network. Node-1 is single homed and Node-2 is dual-homed.  IP
        nodes can be (1) DetNet IP End System, (2) DetNet IP Edge or Relay
        node or (3) IP End System.
      </t>

<figure align="center" anchor="fig_ip_detnet_to_tsn"
              title="DetNet (DN) Enabled IP Network over a TSN sub-network">
<artwork><![CDATA[
    IP (DetNet)                   IP (DetNet)
      Node-1                        Node-2

   ............                  ............
<--: Service  :-- DetNet flow ---: Service  :-->
   +----------+                  +----------+
   |Forwarding|                  |Forwarding|
   +--------.-+    <-TSN Str->   +-.-----.--+
             \      ,-------.     /     /
              +----[ TSN-Sub ]---+     /
                   [ Network ]--------+
                    `-------'
<----------------- DetNet IP ----------------->
]]></artwork>
      </figure>

      <t>
        The Time-Sensitive Networking (TSN) Task Group of the IEEE 802.1
        Working Group have defined (and are defining) a number of
        amendments to <xref target="IEEE8021Q">IEEE 802.1Q</xref> that
        provide zero congestion loss and bounded latency in bridged
        networks. Furthermore <xref target="IEEE8021CB">IEEE
        802.1CB</xref> defines frame replication and elimination
        functions for reliability that should prove both compatible with
        and useful to, DetNet networks.  All these functions have to
        identify flows those require TSN treatment.  </t><t> As is the
        case for DetNet, a Layer 2 network node such as a bridge may
        need to identify the specific DetNet flow to which a packet
        belongs in order to provide the TSN/DetNet QoS for that packet.
        It also may need additional marking, such as the priority field
        of an IEEE Std 802.1Q VLAN tag, to give the packet proper
        service.
      </t>
          <t>
            TSN capabilities of the TSN sub-network are made available for IP
            (DetNet) flows via the protocol interworking function defined in
            <xref target="IEEE8021CB">IEEE 802.1CB</xref>. For example,
            applied on the TSN edge port connected to the IP (DetNet) node it
            can convert an ingress unicast IP (DetNet) flow to use a specific
            multicast destination MAC address and VLAN, in order to direct the
            packet through a specific path inside the bridged network. A
            similar interworking pair at the other end of the TSN sub-network
            would restore the packet to its original destination MAC address
            and VLAN.
          </t>
          <t>
            Placement of TSN functions depends on the TSN capabilities of
            nodes. IP (DetNet) Nodes may or may not support TSN functions. For
            a given TSN Stream (i.e., DetNet flow) an IP (DetNet) node is
            treated as a Talker or a Listener inside the TSN sub-network.
          </t>

          <section title="TSN Stream ID Mapping">
            <t>
              DetNet IP Flow and TSN Stream mapping is based on the active
              Stream Identification function, that operates at the frame
              level. <xref target="IEEE8021CB">IEEE 802.1CB</xref> defines an
              Active Destination MAC and VLAN Stream identification function,
              what can replace some Ethernet header fields namely (1) the
              destination MAC-address, (2) the VLAN-ID and (3) priority
              parameters with alternate values. Replacement is provided for
              the frame passed down the stack from the upper layers or up the
              stack from the lower layers.
            </t>
            <t>
              Active Destination MAC and VLAN Stream identification can be
              used within a Talker to set flow identity or a Listener to
              recover the original addressing information. It can be used also
              in a TSN bridge that is providing translation as a proxy service
              for an End System. As a result IP (DetNet) flows can be mapped
              to use a particular {MAC-address, VLAN} pair to match the Stream
              in the TSN sub-network.
            </t>
            <t>
              From the TSN sub-network perspective DetNet IP nodes without any
              TSN functions can be treated as TSN-unaware Talker or Listener.
              In such cases relay nodes in the TSN sub-network MUST modify the
              Ethernet encapsulation of the DetNet IP flow (e.g., MAC
              translation, VLAN-ID setting, Sequence number addition, etc.) to
              allow proper TSN specific handling of the flow inside the
              sub-network. This is illustrated in <xref
              target="fig_ip_without_tsn"/>.
            </t>

            <figure align="center" anchor="fig_ip_without_tsn"
                    title="IP (DetNet) node without TSN functions">
              <artwork><![CDATA[
     IP (DetNet)
       Node-1
   <---------->

   ............
<--: Service  :-- DetNet flow ------------------
   +----------+
   |Forwarding|
   +----------+    +---------------+
   |    L2    |    | L2 Relay with |<--- TSN ----
   |          |    | TSN function  |    Stream
   +-----.----+    +--.---------.--+
          \__________/           \______

    TSN-unaware
     Talker /          TSN-Bridge
     Listener             Relay
                 <-------- TSN sub-network -------
]]></artwork>
            </figure>

            <t>
              IP (DetNet) nodes being TSN-aware can be treated as a
              combination of a TSN-unaware Talker/Listener and a TSN-Relay, as
              shown in <xref target="fig_ip_with_tsn"/>.  In such cases the IP
              (DetNet) node MUST provide the TSN sub-network specific Ethernet
              encapsulation over the link(s) towards the sub-network. An
              TSN-aware IP (DetNet) node MUST support the following TSN
              components:
              <list style="numbers">
                <t>
                  For recognizing flows:
                  <list style="symbols">
                    <t>Stream Identification</t>
                  </list>
                </t>
                <t>
                  For FRER used inside the TSN domain, additionally:
                  <list style="symbols">
                    <t>Sequencing function</t>
                    <t>Sequence encode/decode function</t>
                  </list>
                </t>
                <t>
                  For FRER when the node is a replication or elimination point, additionally:
                  <list style="symbols">
                    <t>Stream splitting function</t>
                    <t>Individual recovery function</t>
                  </list>
                </t>
              </list>
            </t>

            <t>
              [Editor's note: Should we added here requirements regarding IEEE 802.1Q C-VLAN component?]
            </t>

            <figure align="center" anchor="fig_ip_with_tsn"
                    title="IP (DetNet) node with TSN functions">
              <artwork><![CDATA[
               IP (DetNet)
                  Node-2
   <---------------------------------->

   ............
<--: Service  :-- DetNet flow ------------------
   +----------+
   |Forwarding|
   +----------+    +---------------+
   |    L2    |    | L2 Relay with |<--- TSN ---
   |          |    | TSN function  |    Stream
   +-----.----+    +--.------.---.-+
          \__________/        \   \______
                               \_________
    TSN-unaware
     Talker /          TSN-Bridge
     Listener             Relay
                                       <----- TSN Sub-network -----
   <------- TSN-aware Tlk/Lstn ------->
]]></artwork>
            </figure>

            <t>
              A Stream identification component MUST be able to instantiate
              the following functions (1) Active Destination MAC and VLAN
              Stream identification function, (2) IP Stream identification
              function and (3) the related managed objects in Clause 9 of
              <xref target="IEEE8021CB">IEEE 802.1CB</xref>.  IP Stream
              identification function provides a 6-tuple match.
            </t>
            <t>
              The Sequence encode/decode function MUST support the Redundancy
              tag (R-TAG) format as per Clause 7.8 of <xref
              target="IEEE8021CB">IEEE 802.1CB</xref>.
            </t>
          </section>
          <section title="TSN Usage of FRER">
            <t>
              TSN Streams supporting DetNet flows may use Frame Replication
              and Elimination for Redundancy (FRER) [802.1CB] based on the
              loss service requirements of the TSN Stream, which is derived
              from the DetNet service requirements of the DetNet mapped flow.
              The specific operation of FRER is not modified by the use of
              DetNet and follows <xref target="IEEE8021CB">IEEE
              802.1CB</xref>.
            </t>
            <t>
              FRER function and the provided service recovery is available
              only within the TSN sub-network (as shown in <xref
              target="fig_pref_in_subnets"/>) as the Stream-ID and the TSN
              sequence number are not valid outside the sub-network.  An IP
              (DetNet) node represents a L3 border and as such it terminates
              all related information elements encoded in the L2 frames.
            </t>
          </section>
          <section title="Procedures">
            <t>
              [Editor's note: This section is TBD - covers required
              behavior of a TSN-aware DetNet node using a TSN underlay.]
            </t>
            <t>
	      This section provides DetNet IP data plane procedures to
	      interwork with a TSN underlay sub-network when the IP
	      (DetNet) node acts as a TSN-aware Talker or Listener (see
	      <xref target="fig_ip_with_tsn"/>). These procedures have
	      been divided into the following areas: flow
	      identification, mapping of a DetNet flow to a TSN Stream
	      and ensure proper TSN encapsulation.
            </t>
            <t>
	      Flow identification procedures are described in <xref
	      target="ip-flow-id"/>.  A TSN-aware IP (DetNet) node SHALL
	      support the Stream Identification TSN components as per
	      <xref target="IEEE8021CB">IEEE 802.1CB</xref>.
            </t>
            <t>
	      Implementations of this document SHALL use management and
	      control information to map a DetNet flow to a TSN
	      Stream. N:1 mapping (aggregating DetNet flows in a single
	      TSN Stream) SHALL be supported. The management or control
	      function that provisions flow mapping SHALL ensure that
	      adequate resources are allocated and configured to provide
	      proper service requirements of the mapped flows.
            </t>
            <t>
	      For proper TSN encapsulation implementations of this
	      document SHALL support active Stream Identification
	      function as defined in chapter 6.6 in <xref
	      target="IEEE8021CB">IEEE 802.1CB</xref>.
            </t>
            <t>
	      A TSN-aware IP (DetNet) node SHALL support Ethernet
	      encapsulation with Redundancy tag (R-TAG) as per chapter
	      7.8 in <xref target="IEEE8021CB">IEEE 802.1CB</xref>.
            </t>
            <t>
	      Depending whether FRER functions are used in the TSN
	      sub-network to serve the mapped TSN Stream, a TSN-aware IP
	      (DetNet) node SHALL support Sequencing function and
	      Sequence encode/decode function as per chapter 7.4 and 7.6
	      in <xref target="IEEE8021CB">IEEE
	      802.1CB</xref>. Furthermore when a TSN-aware IP (DetNet)
	      node acting as a replication or elimination point for FRER
	      it SHALL implement the Stream splitting function and the
	      Individual recovery function as per chapter 7.7 and 7.5 in
	      <xref target="IEEE8021CB">IEEE 802.1CB</xref>.
            </t>
          </section>
          <section title="Management and Control Implications">
            <t>
              [Editor's note: This section is TBD
              Covers Creation, mapping, removal of TSN Stream IDs, related
              parameters and,when needed, configuration of FRER. Supported
              by management/control plane.]
            </t>
            <t>
	      DetNet flow and TSN Stream mapping related information are
	      required only for TSN-aware IP (DetNet) nodes. From the
	      Data Plane perspective there is no practical difference
	      based on the origin of flow mapping related information
	      (management plane or control plane).
            </t>
            <t>
	      TSN-aware DetNet IP nodes are member of both the DetNet
	      domain and the TSN sub-network.  Within the TSN
	      sub-network the TSN-aware IP (DetNet) node has a TSM-aware
	      Talker/Listener role, so TSN specific management and
	      control plane functionalities must be implemented.  There
	      are many similarities in the management plane techniques
	      used in DetNet and TSN, but that is not the case for the
	      control plane protocols. For example, RSVP-TE and MSRP
	      behaves differently. Therefore management and control
	      plane design is an important aspect of scenarios, where
	      mapping between DetNet and TSN is required.
	    </t>
	    <t>
	      In order to use a TSN sub-network between DetNet nodes,
	      DetNet specific information must be converted to TSN
	      sub-network specific ones. DetNet flow ID and flow related
	      parameters/requirements must be converted to a TSN Stream
	      ID and stream related parameters/requirements. Note that,
	      as the TSN sub-network is just a portion of the end2end
	      DetNet path (i.e., single hop from IP perspective), some
	      parameters (e.g., delay) may differ significantly. Other
	      parameters (like bandwidth) also may have to be tuned due
	      to the L2 encapsulation used in the TSN sub-network.
	    </t>
	    <t>
	      In some case it may be challenging to determine some TSN
	      Stream related information. For example on a TSN-aware IP
	      (DetNet) node that acts as a Talker, it is quite obvious
	      which DetNet node is the Listener of the mapped TSN stream
	      (i.e., the IP Next-Hop). However it may be not trivial to
	      locate the point/interface where that Listener is
	      connected to the TSN sub-network. Such attributes may
	      require interaction between control and management plane
	      functions and between DetNet and TSN domains.
	    </t>
            <t>
	      Mapping between DetNet flow identifiers and TSN Stream
	      identifiers, if not provided explicitly, can be done by a
	      TSN-aware IP (DetNet) node locally based on information
	      provided for configuration of the TSN Stream
	      identification functions (IP Stream identification and
	      active Stream identification function).
	    </t>
	    <t>
	      Triggering the setup/modification of a TSN Stream in the
	      TSN sub-network is an example where management and/or
	      control plane interactions are required between the DetNet
	      and TSN sub-network. TSN-unaware IP (DetNet) nodes make
	      such a triggering even more complicated as they are fully
	      unaware of the sub-network and run independently.
	    </t>
	    <t>
	      Configuration of TSN specific functions (e.g., FRER)
	      inside the TSN sub-network is a TSN specific decision and
	      may not be visible in the DetNet domain.
	    </t>
          </section>
        </section>

		
		
	
		  
		  
		  
		  